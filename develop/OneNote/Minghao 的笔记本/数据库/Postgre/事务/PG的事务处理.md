PG 对 DML （select/update/insert/delete 命令）使用 SSI（可串行化快照隔离 serializable snapshot isolation），对 DDL 使用 （CREATE TABLE）使用2PL（两阶段锁定 two phase locking）
 
PG 在 9.1 之前使用的是 SI，但是这种隔离存在==写偏序==问题，

==写偏序==指的是由于两个事务在各自的隔离视图中，处理的是不同的元组，所以在SI隔离级别下并不会发生冲突，各自更新成功，最终导致违反数据整体性约束

**MVCC（Multi-Version Concurrency Control，多版本并发控制）** 和 **SSI（Serializable Snapshot Isolation，可串行化快照隔离）** 是数据库并发控制中的两个概念，它们之间有密切的关系，特别是在处理事务隔离和一致性问题时。
 
### 1. **MVCC（多版本并发控制）**  
MVCC 是一种用于处理数据库并发操作的机制，允许多个事务同时访问数据库，而不会因为读写冲突而导致阻塞。它通过维护数据的多个版本，确保读操作总是能够读取到一个一致的快照，而不必等待写操作完成。
 
#### **MVCC 的关键点：**  
- **版本控制**：数据库在每次数据修改时，会创建一个新版本的数据行，而旧版本的数据行会保留一段时间。这样，读操作可以选择读取最适合其隔离级别的版本。  
- **快照隔离（Snapshot Isolation, SI）**：在 MVCC 系统中，事务在开始时会看到数据库的一个快照，即在此时点的数据库状态。这个快照在整个事务过程中保持不变（读操作总是基于这个快照），直到事务提交为止。
 
MVCC 的实现可以避免脏读和不可重复读，提供更高效的并发处理。
 
### 2. **SSI（可串行化快照隔离）**  
SSI 是一种基于 MVCC 的增强隔离级别，旨在实现可串行化（Serializable）隔离级别的并发控制。可串行化隔离级别是最高的隔离级别，要求事务的执行结果必须与事务按某种顺序串行执行的结果相同。
 
#### **SSI 的关键点：**  
- **基于 SI 的基础**：SSI 基于快照隔离（SI），但对其进行了增强，以解决 SI 隔离级别下可能出现的并发异常（如写偏序问题）。  
- **冲突检测和回滚**：SSI 在事务提交时，会检测事务之间的写入冲突或潜在的写偏序问题。如果检测到可能导致数据不一致的并发冲突，SSI 会选择回滚其中一个事务，从而确保最终结果等同于某种串行执行顺序。  
- **保持高并发性**：虽然 SSI 提供了可串行化的保证，但它不像传统的串行化隔离级别那样简单地阻止事务并发执行。相反，它允许事务并发运行，并在提交时进行冲突检测，这使得系统能够在保证一致性的同时保持较高的并发性。
 
### 3. **MVCC 与 SSI 的关系**  
- **底层机制**：SSI 是建立在 MVCC 之上的。MVCC 提供了快照隔离的基础，使事务能够在一致的快照上执行操作，而不必担心其他事务的并发写操作。  
- **增强隔离级别**：在 MVCC 系统中，标准的快照隔离（SI）不能防止一些复杂的并发异常（如写偏序）。SSI 在 MVCC 的基础上增加了额外的检查机制，确保即使在复杂的并发场景下，事务的执行结果也能满足可串行化的要求。  
- **冲突检测**：MVCC 允许多个事务基于不同的快照并发执行，而 SSI 则在事务提交时检查这些事务的写入是否会导致数据不一致，从而决定是否需要回滚某个事务。
 
### 4. **实际应用**  
- **PostgreSQL**：PostgreSQL 是一个使用 MVCC 来实现并发控制的数据库管理系统，并且它实现了 SSI 隔离级别，允许用户在需要时使用可串行化隔离级别来保证数据一致性。  
- **效率与一致性**：MVCC 提供了高效的并发处理，而 SSI 在 MVCC 的基础上进一步增强了隔离级别，提供了强一致性保证，适用于需要最高数据一致性要求的场景。
 
### 总结  
**MVCC** 提供了一种高效的并发控制机制，通过维持数据的多个版本来实现快照隔离，防止脏读和不可重复读。而 **SSI** 则是建立在 MVCC 之上的一种增强型隔离级别，通过冲突检测和回滚机制，确保事务的执行结果符合可串行化的要求。两者共同作用，在保证高并发性的同时，确保数据库的一致性和隔离性。

![[PG的事务处理 - Ink.svg]]
